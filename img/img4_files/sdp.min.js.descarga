// Manager for SemafuroDataPixel v1.2
(function(e){let t=!1,a=document.getElementById('sdp_pixel')?.dataset?.clientid||null,o=!!a,n=e.localStorage.getItem('user_im'),i=o?null:e.localStorage.getItem('aztsession'),s=e.location.host.split('.'),r='.'+s[s.length-2]+'.'+s[s.length-1];function l(t){return{data_device:{channelId:t,device:'WEB',deviceType:u.model.brand,deviceId:null,deviceIdType:null,deviceModel:u.browser,operative_system:u.model.os,adid:null,idfa:null},origin_url:e.location.href}}async function c(e){return await fetch('https://f2hrjgpiik.execute-api.us-east-1.amazonaws.com/dev2/login/anonymous',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':'9A5A65a121284662a3E56467bae962C5N6gJo'},body:JSON.stringify(e)}).then((function(e){if(e.ok)return e.json();Promise.reject(e)})).then((function(e){return e})).catch((function(e){console.warn('[Semafuro DataPixel] Error de conexión:',e)}))}g('[SDP]:','PartnerHost:',o),e.addEventListener('message',(async function(t){let s='dz7188oz6lnyb.cloudfront.net';if(t.origin==='https://'+s&&(g('[SDP]:','Recibiendo mensaje de Pixel en:',t.origin),g('[SDP]:','Mensaje de Pixel (base 64):',t.data),'string'==typeof t.data)){let u=t.data.split('|');if('semafurodatapixel'!==u[0])return;if(/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/.test(u[1])){const f=decodeURIComponent(e.atob(u[1]));try{const u=JSON.parse(f);if(g('[SDP]:','Mensaje de Pixel (parsed):',u),'handshake'===u.method){if(u.im){if(!n&&(g('[SDP]:','No tenemos IM local, se utilizará el del pixel:',u.im),e.localStorage.setItem('user_im',u.im),!o)){d.setData(u.im);let e=31536e3;document.cookie=`perm_im=${u.im};max-age=${e};path=/;domain=${r};samesite=none;secure=true;`}}else if(o?n||(n=await async function(){if(e.fetched)return null;const t='bB6UbsL4JuOpbGF8E6EnqVAXg3SGT54mhExUPnUZG',o='https://qn7ubxj566.execute-api.us-east-1.amazonaws.com/dev';return await fetch(`${o}/public/partner/${a}`,{method:'GET',headers:{'Content-Type':'application/json','x-api-key':t}}).then((function(t){if(e.fetched=!0,t.ok)return t.json();Promise.reject(t)})).then((async function(e){if(e.channelid){const t=l(e.channelid),a=await c(t);return g('[SDP]:','response:',a),a.im?a.im:null}})).catch((function(e){return console.warn('[Semafuro DataPixel] Error de conexión:',e),null}))}()):n||(n=await async function(){if(e.fetched)return null;e.fetched=!0;let t=document.body.dataset.loginconfig,a=null,o=null;if(t)try{let e=JSON.parse(t);a=e?.rsid}catch(e){a=null}if(a){if(/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/.test(a))try{let e=JSON.parse(decodeURIComponent(atob(a)));o=e?.channelId}catch(e){o=null}}if(o){const e=l(o),t=await c(e);return g('[SDP]:','response:',t),t.im?t.im:null}}()),g('[SDP]:','No hay IM de pixel, se enviará el IM local:',n),n){if(e.localStorage.setItem('user_im',n),!o){d.setData(n);let e=31536e3;document.cookie=`perm_im=${n};max-age=${e};path=/;domain=${r};samesite=none;secure=true;`}const a=JSON.stringify({method:'setIM',im:n});g('[SDP]:','Enviando datos a Pixel:',a);const i=e.btoa(encodeURIComponent(a));t.source.postMessage(`semafurodatapixel|${i}`,'https://'+s)}if(!o){let e=d.getData('sessionStartTime'),a=d.getData('status'),o=0,n=null,r=null,l=null,c=null;u.sid?(o=d.getData('sessionStartTime',u.sid),n=d.getData('status',u.sid),r=d.getData('im',u.sid),l=d.getData('displayName',u.sid),c=d.getData('profilePicture',u.sid),g('[SDP]:',`localStatus:${a}`,`remoteStatus:${n}`),a!==n?n&&'anonymous'!==n?(g('[SDP]:',`localSessionStart:${e}`,`remoteSessionStart:${o}`),e>o?'anonymous'!==a?(g('[SDP]:','Actualizando SID remoto...'),p(i,t.source,s)):(g('[SDP]:','Actualizando local...'),m(u.sid,r,n,l,c)):e<o&&(g('[SDP]:','Actualizando local...'),m(u.sid,r,n,l,c))):(g('[SDP]:','Guardando SID...'),p(i,t.source,s)):sessionStorage.removeItem('reload_after_update')):(g('[SDP]:','No hay SID de pixel, se generará uno local'),p(i,t.source,s))}}}catch(e){console.warn('[SDP]:','Error leyendo Data Pixel:',e)}}}}));const d={getData(t=null,a=null){let o,n=a||e.localStorage.getItem('aztsession'),i=null;if(n){if(/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/.test(n))try{o=JSON.parse(decodeURIComponent(atob(n)))}catch(e){o=null}else try{o=JSON.parse(n)}catch(e){o=null}if(o)if(t){let e=null;if(void 0!==o[t])e=o[t];else for(const a in o)void 0!==o[a][t]&&(e=o[a][t]);i=e}else i=o}return i},setData(t=null){if(!t)return;let a={displayName:null,idProvider:null,userToken:null,profilePicture:null};a.im=t;let o={user:a,provider:'anonymous',status:'anonymous',sessionStartTime:(new Date).getTime()};e.localStorage.setItem('aztsession',e.btoa(encodeURIComponent(JSON.stringify(o))))}},u={userAgent:navigator.userAgent.toLowerCase(),get model(){const e=this.userAgent;let t=!1,a='Unknown deviceType',o='Unknown Device',n='Unknown OS',i={};return/blackberry/.test(e)&&(a='mobile',o='BlackBerry',n='BlackBerry OS'),/win/.test(e)&&(a='desktop',o='Windows PC',n='Windows'),/iemobile/.test(e)&&(a='mobile',o='Windows Phone',n='Windows'),/mac/.test(e)&&(a='desktop',o='Macintosh Computer',t=e.match(/os x\s([0-9_]*)/i)||e.match(/os x\s([0-9.]*)/i),n=t?'MacOS '+t[1].replace(/_/g,'.'):'MacOS'),/iphone/.test(e)&&(a='mobile',o='iPhone',t=e.match(/os\s([0-9.]*)/i)||!1,n=t?'iOS '+t[1]:'iOS'),/ipad/.test(e)&&(a='mobile',o='iPad',t=e.match(/os\s([0-9.]*)/i)||!1,n=t?'iPadOS '+t[1]:'iPadOS'),/linux/.test(e)&&(a='desktop',o='Linux',n=/ubuntu/.test(e.toLowerCase())?'Ubuntu':'Linux'),/android/.test(e)&&(a='mobile',o=/bbb/.test(e)?'BlackBerry':'Android',t=e.match(/android\s([0-9.]*)/i)||!1,n=t?'Android '+t[1]:'Android'),/huawei/.test(e)&&(a='mobile',o='Huawei',n='HarmonyOS'),i.deviceType=a,i.brand=o,i.os=n,i},get browser(){const e=this.userAgent;let t=!1,a='Generic Browser';return/trident/.test(e)&&(t=e.match(/trident\/([0-9.]*)/i),a='Internet Explorer'),/firefox/.test(e)&&(t=e.match(/firefox\/([0-9.]*)/i),a='Firefox'),/safari/.test(e)&&(t=e.match(/safari\/([0-9.]*)/i),a='Safari'),(/chrome/.test(e)||/crios/.test(e))&&(t&&(t=!1),t=e.match(/chrome\/([0-9.]*)/i)?e.match(/chrome\/([0-9.]*)/i):e.match(/crios\/([0-9.]*)/i),a='Chrome'),/opr/.test(e)&&(t&&(t=!1),t=e.match(/opr\/([0-9.]*)/i),a='Opera'),/opera/.test(e)&&/mini/.test(e)&&(t&&(t=!1),t=e.match(/mini\/([0-9.]*)/i),a='Opera Mini'),(/fban/.test(e)||/fbav/.test(e))&&(t=!1,a='Facebook Web View'),/edg/.test(e)&&(t&&(t=!1),t=/edgios/.test(e)?e.match(/edgios\/([0-9.]*)/i):/edga/.test(e)?e.match(/edga\/([0-9.]*)/i):/edge/.test(e)?e.match(/edge\/([0-9.]*)/i):e.match(/edg\/([0-9.]*)/i),a='Edge'),t=t?' '+t[1]:'',a+t}};function m(t=null,a=null,o=null,n=null,i=null){e.localStorage.setItem('aztsession',t),e.localStorage.setItem('user_im',a);document.cookie=`perm_im=${a};max-age=31536000;path=/;domain=${r};samesite=none;secure=true;`,'connected'===o?(e.localStorage.setItem('usernm',n),i&&(i=(i=i.replace('http:','')).replace('https:',''),e.localStorage.setItem('userpt',i)),document.cookie=`user_im=${a};max-age=31536000;path=/;domain=${r};samesite=none;secure=true;`):(e.localStorage.getItem('usernm')&&e.localStorage.removeItem('usernm'),e.localStorage.getItem('userpt')&&e.localStorage.removeItem('userpt'),document.cookie=`user_im=;max-age=1;path=/;domain=${r};samesite=none;secure=true;`),sessionStorage.getItem('reload_after_update')?(g('[SDP]:','reload_after_update encontrado en Session Storage, recarga cancelada'),sessionStorage.removeItem('reload_after_update')):(g('[SDP]:','Procedemos a la recarga...'),sessionStorage.setItem('reload_after_update',!0),e.location.reload())}function p(t=null,a=null,o=null){if(!t||!a||!o)return void g('[SDP]:','No es posible guardar el SID porque la data está incompleta:','SID:'+t,'Target:'+a,'Sender:'+o);const n=JSON.stringify({method:'setSID',sid:t});g('[SDP]:','Enviando datos a Pixel:',n);const i=e.btoa(encodeURIComponent(n));a.postMessage(`semafurodatapixel|${i}`,'https://'+o)}function g(...e){t&&e&&console.info(e)}})(window);